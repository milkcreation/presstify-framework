#!/usr/bin/env php
<?php

// Debogguage.
use Dotenv\Dotenv;

error_reporting(E_ALL);
ini_set('display_errors', 1);

// Récupération des vendors.
$paths = [
    __DIR__.'/../autoload.php',
    __DIR__.'/../../../autoload.php'
];
foreach ($paths as $path) {
    if (file_exists($path)) {
        require_once $path;
        break;
    }
}

// Chargement de Wordpress
$wp_paths = [
    __DIR__ . '/../../wp-load.php',
    __DIR__ . '/../../../../wp-load.php'
];

// Entêtes par défaut
$_SERVER['SERVER_PROTOCOL'] = $_SERVER['SERVER_PROTOCOL'] ?? 'HTTP/1.0';
$_SERVER['HTTP_USER_AGENT'] = $_SERVER['HTTP_USER_AGENT'] ?? '';
$_SERVER['REQUEST_METHOD']  = $_SERVER['REQUEST_METHOD'] ?? 'GET';
$_SERVER['REMOTE_ADDR']     = $_SERVER['REMOTE_ADDR'] ?? '127.0.0.1';
// @see php -i | grep php.ini
$_SERVER['TZ'] = $_SERVER['TZ'] ?? (ini_get('date.timezone') ?: 'UTC');

// Entêtes associées à l'url
if ($url = preg_grep('/^\-\-url\=(.*)/', $argv)) {
    foreach (array_keys($url) as $k) {
        unset($argv[$k]);
    }

    $url = current($url);
    $url = preg_replace('/^\-\-url\=/', '', $url);
} else {
    // Récupération des vendors.
    $vendor_paths = [
        __DIR__ . '/../autoload.php',
        __DIR__ . '/../../../autoload.php'
    ];

    foreach ($vendor_paths as $vendor_path) {
        if (file_exists($vendor_path)) {
            require_once $vendor_path;
            $env = Dotenv::create(dirname(dirname(realpath($vendor_path))));
            $env->load();
            $url = getenv('APP_URL') ?: '';
        }
    }
}

// Entêtes associées à l'url
$url   = $url ?: 'http://localhost';
$parts = parse_url($url);
if (isset($parts['host'])) {
    if (isset($parts['scheme']) && 'https' === strtolower($parts['scheme'])) {
        $_SERVER['HTTPS'] = 'on';
    }

    $_SERVER['HTTP_HOST'] = $parts['host'];
    if (isset($parts['port'])) {
        $_SERVER['HTTP_HOST'] .= ':' . $parts['port'];
    }

    $_SERVER['SERVER_NAME'] = $parts['host'];
};

$_SERVER['REQUEST_URI']  = ($parts['path'] ?? '') . (isset($parts['query']) ? '?' . $parts['query'] : '');
$_SERVER['SERVER_PORT']  = $parts['port'] ?? '80';
$_SERVER['QUERY_STRING'] = $parts['query'] ?? '';

foreach ($wp_paths as $wp_path) {
    if (file_exists($wp_path)) {
        require_once $wp_path;
        break;
    }
}