!function(l,t,a){var i=l.valHooks.div;l.valHooks.div={get:function(e){return void 0===l(e).tifyselect("instance")?i&&i.get&&i.get(e)||void 0:l(e).data("value")},set:function(e,t){if(void 0===l(e).tifyselect("instance"))return i&&i.set&&i.set(e,t)||void 0;l(e).data("value",t)}},l.widget("tify.tifyselect",{options:{disabled:!1,multiple:!1,duplicate:!1,max:-1,trigger:{},picker:{},sortable:{},source:!1,autocomplete:!1},controllers:{handler:"tiFy-selectHandler",trigger:"tiFy-selectTrigger",autocompleteInput:"tiFy-selectAutocomplete",selectedList:"tiFy-selectSelectedItems",picker:"tiFy-selectPicker",pickerList:"tiFy-selectPickerItems",pickerFilter:"tiFy-selectPickerFilter",pickerLoader:"tiFy-selectPickerLoader"},_create:function(){(this.instance=this).el=this.element,this._initOptions(),this._initControllers(),this._initStatusFlags(),this._initEvents()},_initOptions:function(){this.el.data("options")&&l.extend(this.options,l.parseJSON(decodeURIComponent(this.el.data("options")))),this.options.source?("object"!=typeof this.options.source&&(this.options.source={}),this.dataSource=this.options.source):this.dataSource=void 0},_initStatusFlags:function(){this.flags={hasSelection:!1,isDisabled:!0,isMultiple:!1,isDuplicable:!1,isRemovable:!0,isSortable:!1,isOpen:!1,isComplete:!0,page:1,hasArrow:!0,hasFilter:!1,hasSource:!1,hasAutocomplete:!1},this.flags.hasSelection=!!this._count(),this.flags.Disabled=this.options.disabled,this.flags.isMultiple=this.options.multiple,this.flags.isDuplicable=this.options.duplicate&&this.flags.isMultiple,this.flags.isRemovable=!this.flags.Disabled,this.flags.isSortable=!1!==this.options.sortable&&this.flags.isMultiple&&!this.flags.Disabled,this.flags.isOpen=!1,this.flags.isComplete=!1,this.flags.page=1,this.flags.hasSource=void 0!==this.dataSource},_initControllers:function(){var i=this;l.each(this.controllers,function(e,t){i[e]=l("."+t,i.el)})},_initEvents:function(){var e=this;e._initTrigger(),e._initPicker(),e._initSelected(),this.flags.hasSelection?this.el.attr("aria-selection",!0):this.el.attr("aria-selection",!1),this.flags.isMultiple?this.el.attr("aria-multiple",!0):this.el.attr("aria-multiple",!1),this.flags.isSortable?this.el.attr("aria-sortable",!0):this.el.attr("aria-sortable",!1),this.flags.isDuplicable?(this.el.attr("aria-duplicable",!0),this.picker.attr("aria-duplicable",!0)):(this.el.attr("aria-duplicable",!1),this.picker.attr("aria-duplicable",!1)),this.flags.Disabled?this._disable():this._enable()},_initTrigger:function(){var e=this;e.options.trigger=l.extend({class:"",arrow:!0},e.options.trigger),e.picker.addClass(e.options.trigger.class),e.options.trigger.arrow?(e.flags.hasArrow=!0,e.trigger.attr("aria-arrow",!0)):(e.flags.hasArrow=!1,e.trigger.attr("aria-arrow",!1)),e.options.autocomplete&&("object"!=typeof e.options.autocomplete&&(e.options.autocomplete={}),e.flags.hasAutocomplete=!0,e.el.attr("aria-autocomplete",!0),e.flags.isMultiple&&e.selectedList.insertAfter(e.trigger),e.autocompleteInput=l('<input class="tiFy-selectAutocomplete" autocomplete="off"/>').prependTo(e.trigger))},_initPicker:function(){var e=this,t={class:"",placement:"clever",appendTo:"body",delta:{top:0,left:0,width:0},adminbar:!0,filter:!1,loader:"",more:"+"};e.options.picker=l.extend(t,e.options.picker);var i=l(this.options.picker.appendTo);i.length||(i=l("body")),e.picker.appendTo(i).addClass(e.options.picker.class),e.options.picker.filter&&(e.flags.hasFilter=!0,e.picker.attr("aria-filter",!0),e.pickerFilter=l('<input class="tiFy-selectPickerFilter" autocomplete="off"/>').prependTo(e.picker)),e.pickerLoader=l('<div class="tiFy-selectPickerLoader" />').html(t.loader).prependTo(e.picker),this.flags.hasSource&&(e.pickerMore=l('<a href="#" class="tiFy-selectPickerMore" />').html(t.more).prependTo(e.picker),e.picker.attr("aria-complete",!1))},_initSelected:function(){var e=this;e.flags.isSortable?(e.options.sortable=l.extend({handle:'[aria-handle="sort"]',containment:"parent",update:function(){e._reset()}},e.options.sortable),e.sortable=e.selectedList.sortable(e.options.sortable),e.selectedList.disableSelection()):e.sortable=void 0,e._reset()},_open:function(){var e=this;if(!e.flags.isOpen){e.flags.isOpen=!0,e.el.attr("aria-open",!0),e.picker.attr("aria-open",!0);var t=e._getPickerOffset();e.picker.css(t),e._getPickerItems(),e._onOpen()}},_close:function(){var e=this;e.flags.isOpen&&(e.flags.isOpen=!1,e.el.attr("aria-open",!1),e.picker.attr("aria-open",!1),e._onClose())},_enable:function(){var e=this;e.flags.Disabled=!1,e.el.attr("aria-disabled",!1),e.handler.prop("disabled",!1),e._onEnable()},_disable:function(){var e=this;e.flags.Disabled=!0,e.el.attr("aria-disabled",!0),e.handler.prop("disabled",!0),e._onDisable()},_add:function(e){var t=this;!this.flags.isDuplicable&&l('> [data-value="'+e.value+'"]',t.selectedList).length?e.new=!1:(e.new=!0,t.flags.isMultiple||t._removeAll(),e.index=t._count(),l('<li data-label="'+e.label+'" data-value="'+e.value+'" data-index="'+e.index+'">'+(void 0!==e.select?e.select:e.label)+"</li>").appendTo(t.selectedList)),t._onAdd(e)},_remove:function(e){var t=this;t._get(e.index).remove(),l('> [data-index="'+e.index+'"]',t.handler).remove(),l('> [data-value="'+e.value+'"]',t.selectedList).length||l('> [data-value="'+e.value+'"]',t.pickerList).attr("aria-selected",!1),t._onRemove(e)},_get:function(e){return l('> li[data-index="'+e+'"]',this.selectedList)},_removeAll:function(){var t=this;t._all().each(function(){var e=t._getAttrs(l(this));t._get(e.index).remove(),l('> [data-index="'+e.index+'"]',t.handler).remove(),l('> [data-value="'+e.value+'"]',t.selectedList).length||l('> [data-value="'+e.value+'"]',t.pickerList).attr("aria-selected",!1)}),t.el.val(t.handler.val())},_reset:function(){var t=this;l("option",t.handler).remove(),t._all().each(function(){var e=t._getAttrs(l(this));t._setRemovable(e),t._setSortable(e),t._addHandler(e),t._setPicker(e)}),t.el.val(t.handler.val())},_all:function(){return l("> li",this.selectedList)},_count:function(){return this._all().length},_highlight:function(e){l('> [data-value="'+e.value+'"]',this.selectedList).attr("aria-highlight",!0).one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){l(this).attr("aria-highlight",!1)})},_setRemovable:function(e){var t=this;t.flags.isRemovable&&l('<span aria-handle="remove">Ã—</span>').prependTo(t._get(e.index)).on("click.tify_select.selected_remove."+t.instance.uuid,function(){var e=t._getAttrs(l(this).closest("li"));t._remove(e)})},_setSortable:function(e){this.flags.isSortable&&(this.options.sortable.handle?this._get(e.index).prepend('<span aria-handle="sort">...</span>'):this._get(e.index).attr("aria-handle","sort"))},_onOpen:function(){var s=this;l(t).on("click.tify_select.outside"+s.instance.uuid,function(i){var a=!0;l.each(s.controllers,function(e,t){if(l(i.target).is(l("."+t,s.el)))return!(a=!1)}),a&&s._close()}),l(a).on("scroll.tify_select.picker_position."+s.instance.uuid,function(){var e=s._getPickerOffset();s.picker.css(e)}),s.pickerList.on("scroll.tify_select.picker_list."+s.instance.uuid,function(){void 0===s.xhr&&l(this).prop("scrollHeight")-l(this).innerHeight()-l(this).scrollTop()<20&&s._getPickerItems()}),void 0!==s.pickerMore&&s.pickerMore.on("click.tify_select.picker_list."+s.instance.uuid,function(e){e.preventDefault(),e.stopPropagation(),void 0===s.xhr&&s._getPickerItems()}),s.flags.hasFilter&&(s.pickerFilter.focus(),s.pickerFilter.on("keyup.tify_select.picker_filter."+s.instance.uuid,function(){var t=l(this).val();l("> li",s.pickerList).each(function(){var e=new RegExp(t,"i");l(this).data("label").match(e)?l(this).show():l(this).hide()})}).on("click.tify_select.picker_filter."+s.instance.uuid,function(e){e.stopPropagation()}))},_onClose:function(){var e=this;l(t).off("click.tify_select.outside"+e.instance.uuid),l(a).off("scroll.tify_select.picker_position."+e.instance.uuid),e.pickerList.off("scroll.tify_select.picker_list."+e.instance.uuid),e.flags.hasFilter&&e.pickerFilter.off("keyup.tify_select.picker_filter."+e.instance.uuid)},_onEnable:function(){var t=this;t.trigger.on("click.tify_select.open."+t.instance.uuid,function(){t.flags.isOpen?t._close():t._open()}),l('> li:not([aria-disabled="true"])',t.pickerList).on("click.tify_select.picker_item_select."+t.instance.uuid,function(){var e=t._getAttrs(l(this));t._add(e)}),t.flags.isRemovable&&l('> li > [aria-handle="remove"]',t.selectedList).on("click.tify_select.selected_remove."+t.instance.uuid,function(){var e=t._getAttrs(l(this).closest("li"));t._remove(e)}),this._count()||(this.flags.hasSelection=!1,this.el.attr("aria-selection",!1),t.flags.isMultiple||this.autocompleteInput.show(),this.selectedList.hide()),t.flags.hasAutocomplete&&t.autocompleteInput.on("keyup.tify_select.autocomplete."+t.instance.uuid,function(){t._close(),l(this).val()&&(t.pickerList.empty(),t.flags.isComplete=!1,t.flags.page=1,void 0!==t.timeout&&clearTimeout(t.timeout),void 0!==t.xhr&&t.xhr.abort(),t.timeout=setTimeout(function(){t._getPickerItems(),t.xhr.done(function(e){e.length&&t._open()})},1e3))})},_onDisable:function(){var e=this;e.trigger.off("click.tify_select.open."+e.instance.uuid),l("> li",e.pickerList).on("click.tify_select.picker_item_select."+e.instance.uuid),e.flags.isRemovable&&l('> li > [aria-handle="remove"]',e.selectedList).off("click.tify_select.selected_remove."+e.instance.uuid),e.flags.hasAutocomplete&&e.autocompleteInput.off("keyup.tify_select.autocomplete."+e.instance.uuid)},_onAdd:function(e){var t=this;e.new&&(t._setRemovable(e),t._setSortable(e),t._setPicker(e),t._addHandler(e)),t.flags.hasSelection=!0,t.el.attr("aria-selection",!0),t.flags.isMultiple||t.autocompleteInput.hide(),t.selectedList.show(),t._close(),t._highlight(e),t.el.val(t.handler.val()),t._trigger("add")},_onRemove:function(e){this._count()||(this.flags.hasSelection=!1,this.el.attr("aria-selection",!1),this.flags.isMultiple||this.autocompleteInput.show(),this.selectedList.hide()),this.el.val(this.handler.val()),this._trigger("remove")},_getAttrs:function(e){return{label:e.data("label"),value:e.data("value"),index:e.data("index"),picker:e.data("picker")?e.data("picker"):e.data("label"),select:e.data("select")?e.data("select"):e.data("label")}},_addPicker:function(e){var t=this;l('> [data-value="'+e.value+'"]',t.pickerList).length||(l('<li data-label="'+e.label+'" data-value="'+e.value+'" data-index="'+e.value+'" >'+(void 0!==e.picker?e.picker:e.label)+"</li>").appendTo(t.pickerList).on("click.tify_select.picker_item_select."+t.instance.uuid,function(){t._add(e)}),t._setPicker(e))},_setPicker:function(e){l('> [data-value="'+e.value+'"]',this.selectedList).length?l('> [data-value="'+e.value+'"]',this.pickerList).attr("aria-selected",!0):l('> [data-value="'+e.value+'"]',this.pickerList).attr("aria-selected",!1)},_queryPickerArgs:function(){var e={page:this.flags.page};return this.flags.hasAutocomplete&&(e.term=this.autocompleteInput.val()),e},_getPickerItems:function(){var i=this;i.flags.isComplete||this.flags.hasSource&&(i.pickerLoader.show(),i.xhr=l.ajax({url:tify_ajaxurl,data:l.extend(i.dataSource,i._queryPickerArgs()),method:"POST"}).done(function(e){e.length?(l.each(e,function(e,t){i._addPicker(t)}),i.flags.page++):(i.flags.isComplete=!0,i.picker.attr("aria-complete",!0),i.flags.page=1)}).always(function(){i.pickerLoader.hide(),i.xhr=void 0}))},_getPickerOffset:function(){var e=this,t=l.extend({},e.trigger.offset(),{width:e.trigger.outerWidth()}),i=e.options.picker.placement;switch(e.options.picker.delta.top&&(t.top+=e.options.picker.delta.top),e.options.picker.delta.left&&(t.left+=e.options.picker.delta.left),e.options.picker.delta.width&&(t.width+=e.options.picker.delta.width),e.options.picker.adminbar&&(t.top+=l("body").hasClass("admin-bar")?-l("#wpadminbar").outerHeight():0),"clever"===i&&(i=l(a).outerHeight()+l(a).scrollTop()<t.top+e.picker.outerHeight()?"top":"bottom"),i){case"top":t.top-=e.picker.outerHeight()-1;break;case"bottom":t.top+=e.trigger.outerHeight()-1}return t},_addHandler:function(e){l('[data-index="'+e.index+'"]',this.handler).length||l('<option value="'+e.value+'" data-index="'+e.index+'" selected>'+e.label+"</option>").appendTo(this.handler)},sortable:function(){if(this.flags.isSortable)return this.sortable},open:function(){this.flags.Disabled||this._open()},close:function(){this.flags.Disabled||this._close()},enable:function(){this.flags.Disabled&&this._enable()},disable:function(){this.flags.Disabled||this._disable()},destroy:function(){this.el.remove(),this.picker.remove()}})}(jQuery,document,window);