!function($,doc,win){$.widget("tify.tiFyGoogleMapEditor",{componentForm:{street_number:"short_name",route:"long_name",locality:"long_name",country:"long_name",postal_code:"short_name"},_create:function(){this.googleMap=this.element.data("map"),this.geolocationText=this.element.data("geoloc_text"),this.mapOptions=this.element.data("map_options"),this.mapOptions=this._parseMapOptions(this.mapOptions),this.mapCenter={lat:48.85844,lng:2.294555},this.newMarkerToggle=this.element.find(".tiFyGoogleMap-editorNewMarker"),this.panel=this.element.find(".tiFyGoogleMap-editorPanel"),this.autocompleteForm=this.element.data("autocomplete_form"),this.markersList=this.element.find(".tiFyGoogleMap-markers"),this.markers={},this.markersTypes={},this._loadMap(),this._setMarkersTypes(this.element.data("markers_types")),this._setMarkers(this.element.data("markers")),this._setPanelControls(),this._loadAutocomplete(),this._listenEvents()},_parseMapOptions:function(mapOptions){var self=this;return $.each(mapOptions,function(index,value){if("position"===index&&(mapOptions[index]=eval("google.maps.ControlPosition."+value)),"styles"===index&&(mapOptions[index]=JSON.parse(value)),"object"==typeof value)return self._parseMapOptions(value)}),mapOptions},_initMap:function(){this.map=new google.maps.Map(document.getElementById(this.googleMap),this.mapOptions),this._initCenter(),this._responsive(),this._tabShown()},_setCenter:function(){var e=this.map.getCenter();google.maps.event.trigger(this.map,"resize"),this.map.setCenter(e)},_tabShown:function(){var e=this;$('a[data-toggle="tab"]').on("shown.bs.tab",function(t){var a=$(t.target);$(a.attr("href")).find(".tiFyGoogleMap-editorMap").length&&e._setCenter()})},_responsive:function(){var e=this;google.maps.event.addDomListener(window,"resize",function(){e._setCenter()})},_initCenter:function(){var e=this;if(void 0===this.map.getCenter())if(navigator.geolocation){var t=new google.maps.InfoWindow({map:this.map});navigator.geolocation.getCurrentPosition(function(a){var o={lat:a.coords.latitude,lng:a.coords.longitude};e.mapCenter=o,t.setPosition(o),t.setContent(e.geolocationText),e.map.setCenter(o)},function(){e._handleLocationError(!0,t,e.map.getCenter())})}else this.map.setCenter(e.mapCenter);else this.mapCenter={lat:this.map.getCenter().lat(),lng:this.map.getCenter().lng()}},_handleLocationError:function(e,t,a){t.setPosition(a),t.setContent(e?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")},_loadMap:function(){google.maps.event.addDomListener(window,"load",this._initMap())},_setPanelControls:function(){this.saveMarkerToggle=this.panel.find(".tiFyControl-adminPanelControlsItemButton--save"),this.removeMarkerToggle=this.panel.find(".tiFyControl-adminPanelControlsItemButton--remove")},_loadAutocomplete:function(){var e=this;$(document.getElementById(this.autocompleteForm)).length&&(this.autocomplete=new google.maps.places.Autocomplete(document.getElementById(this.autocompleteForm),this.element.data("autocomplete_options")),this.autocomplete.addListener("place_changed",function(){e._fillInAddress()}),$(document).on("focus","#"+this.autocompleteForm,function(t){e._autocompleteGeolocate()}))},_setMarkersTypes:function(e){for(id in e)e[id].icon=this._setMarkerTypeIcon(e[id].icon),this.markersTypes[id]=e[id]},_setMarkerTypeIcon:function(e){var t=this;switch(typeof e.src){case"string":var a=new Image;a.src=e.src,e.src={},e.src.url=a.src,a.onload=function(){var o=a.width,n=a.height;e.src.size=new google.maps.Size(o,n),e.src.origin=new google.maps.Point(0,0),e.src.anchor=t._setMarkerTypeIconAnchor(e)};break;case"object":void 0===e.width&&(e.src.width=32),void 0===e.width&&(e.src.height=32),e.src.size=new google.maps.Size(e.src.width,e.src.height),e.src.origin=new google.maps.Point(0,0),e.src.anchor=this._setMarkerTypeIconAnchor(e)}return e},_setMarkerTypeIconAnchor:function(e){var t;switch(e.anchor){case"TOP_LEFT":t=new google.maps.Point(0,0);break;case"TOP_CENTER":t=new google.maps.Point(e.src.width/2,0);break;case"TOP_RIGHT":t=new google.maps.Point(e.src.width,0);break;case"CENTER_LEFT":t=new google.maps.Point(0,e.src.height/2);break;case"CENTER":t=new google.maps.Point(e.src.width/2,e.src.height/2);break;case"CENTER_RIGHT":t=new google.maps.Point(e.src.width,e.src.height/2);break;case"BOTTOM_LEFT":t=new google.maps.Point(0,e.src.height);break;case"BOTTOM_CENTER":t=new google.maps.Point(e.src.width/2,e.src.height);break;case"BOTTOM_RIGHT":t=new google.maps.Point(e.src.width,e.src.height);break;default:t=new google.maps.Point(0,0)}return t},_autocompleteGeolocate:function(){var e=this;navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){var a={lat:t.coords.latitude,lng:t.coords.longitude},o=new google.maps.Circle({center:a,radius:t.coords.accuracy});e.autocomplete.setBounds(o.getBounds())})},_fillInAddress:function(){var e=this.autocomplete.getPlace();this.element.find("[data-autocomplete]").each(function(){$(this).val("")}),$('[data-autocomplete="lat"]',this.element).length&&$('[data-autocomplete="lat"]',this.element).val(e.geometry.location.lat()),$('[data-autocomplete="lng"]',this.element).length&&$('[data-autocomplete="lng"]',this.element).val(e.geometry.location.lng()),$('[data-autocomplete="formatted_address"]',this.element).length&&$('[data-autocomplete="formatted_address"]',this.element).val(e.formatted_address);for(var t=0;t<e.address_components.length;t++){var a=e.address_components[t].types[0];if(this.componentForm[a]&&$('[data-autocomplete="'+a+'"]').length){var o=e.address_components[t][this.componentForm[a]];$('[data-autocomplete="'+a+'"]',this.element).val(o)}}},_listenEvents:function(){this._on(this.document,{click:function(e){$(e.target).closest(this.newMarkerToggle).length||$(e.target).is(this.newMarkerToggle)?this._addNewMarker():$(e.target).closest(this.saveMarkerToggle).length||$(e.target).is(this.saveMarkerToggle)?this._saveMarker():$(e.target).is($(".tiFyGoogleMap-markerRemove",this.markersList))||$(e.target).is(this.removeMarkerToggle)?this._removeMarker(e):$(e.target).is($(".tiFyGoogleMap-markerEdit",this.markersList))?this._editMarker(e):$(e.target).closest(this.panel).length||$(e.target).closest(".tiFyGoogleMap-editorMap").length||this._clean()},mouseover:function(e){$(e.target).is($(".tiFyGoogleMap-markerEdit",this.markersList))&&!$(e.target).closest(".tiFyGoogleMap-marker").hasClass("tiFyGoogleMap-marker--editing")&&this._toggleBounceMarker($(e.target).closest(".tiFyGoogleMap-marker").data("id"))},mouseout:function(e){$(e.target).is($(".tiFyGoogleMap-markerEdit",this.markersList))&&!$(e.target).closest(".tiFyGoogleMap-marker").hasClass("tiFyGoogleMap-marker--editing")&&this._toggleBounceMarker($(e.target).closest(".tiFyGoogleMap-marker").data("id"))}})},_closePanel:function(){var e=this;$(".tiFyControl-adminPanel",this.panel).tiFyAdminPanel("close"),setTimeout(function(){e._emptyPanel()},300)},_emptyPanel:function(){this.panel.is(":empty")||this.panel.empty()},_updatePanel:function(e){var t=this;this.panel.html(e),$(".tiFyControl-adminPanel",this.panel).tiFyAdminPanel(),this._setPanelControls(),this._loadAutocomplete(),setTimeout(function(){$(".tiFyControl-adminPanel",t.panel).tiFyAdminPanel("open")},1)},_addNewMarker:function(){var e=this;(this.panel.is(":empty")||0!==this.panel.find(".tiFyControl-adminPanel").data("id"))&&$.ajax({url:tify_ajaxurl,dataType:"json",method:"POST",data:{action:this.element.data("new_action"),_ajax_nonce:this.element.data("ajax_nonce"),autocomplete_id:this.element.data("autocomplete_form")},beforeSend:function(){e.newMarkerToggle.addClass("tiFyGoogleMap-editorNewMarker--loading"),e._emptyPanel()},success:function(t){t.success&&e._updatePanel(t.data)},complete:function(){e.newMarkerToggle.removeClass("tiFyGoogleMap-editorNewMarker--loading")}})},_saveMarker:function(){var e=this;formDatas={},fields=this.element.data("fields");for(var t in fields)$('[data-save="'+fields[t]+'"]',this.element).length&&(formDatas[fields[t]]=$('[data-save="'+fields[t]+'"]',this.element).val());$.ajax({url:tify_ajaxurl,dataType:"json",method:"POST",data:{post_id:$("#post_ID").val(),action:this.element.data("save_action"),_ajax_nonce:this.element.data("ajax_nonce"),marker:formDatas,meta_id:$(".tiFyControl-adminPanel",this.panel).data("id")},beforeSend:function(){e.panel.find(".tiFyControl-adminPanelControlsItem--save").addClass("tiFyControl-adminPanelControlsItem--save--loading"),e.saveMarkerToggle.addClass("disabled")},success:function(t){t.success?($('[data-id="'+t.data.id+'"]',e.markersList).length?$('[data-id="'+t.data.id+'"]',e.markersList).replaceWith(t.data.render):e.markersList.append(t.data.render),e._updateMapMarker(t.data.id,t.data.marker,!0)):alert(t.data),e.panel.is(":empty")||e._closePanel()},complete:function(){e.panel.find(".tiFyControl-adminPanelControlsItem--save").removeClass("tiFyControl-adminPanelControlsItem--save--loading"),e.saveMarkerToggle.removeClass("disabled")}})},_removeMarker:function(e){e.preventDefault();var t=this,a=$(e.target).is(this.removeMarkerToggle)?$(".tiFyControl-adminPanel",this.panel).data("id"):$(e.target).closest(".tiFyGoogleMap-marker").data("id"),o=$('[data-id="'+a+'"]',this.markersList);$.ajax({url:tify_ajaxurl,dataType:"json",method:"POST",data:{action:this.element.data("remove_action"),_ajax_nonce:this.element.data("ajax_nonce"),meta_id:a},beforeSend:function(){$(e.target).is(t.removeMarkerToggle)&&t.panel.find(".tiFyControl-adminPanelControlsItem--save").addClass("tiFyControl-adminPanelControlsItem--save--loading"),o.addClass("tiFyGoogleMap-marker--loading")},success:function(e){e.success&&(o.fadeOut(400,function(){$(this).remove()}),t._removeMapMarker(e.data),t._centerMap()),t.panel.is(":empty")||t.panel.find(".tiFyControl-adminPanel").data("id")!==a||t._closePanel()},complete:function(){$(e.target).is(t.removeMarkerToggle)&&t.panel.find(".tiFyControl-adminPanelControlsItem--save").removeClass("tiFyControl-adminPanelControlsItem--save--loading"),o.length&&o.removeClass("tiFyGoogleMap-marker--loading")}})},_editMarker:function(e){e.preventDefault();var t=this,a=$(e.target).closest(".tiFyGoogleMap-marker"),o=a.data("id");this._centerMap(o),this._toggleBounceMarker(o,!0),this._removeMarkersAnimation(o),a.addClass("tiFyGoogleMap-marker--editing").siblings().removeClass("tiFyGoogleMap-marker--editing"),this.panel.is(":empty")||this.panel.find(".tiFyControl-adminPanel").data("id")!==o?$.ajax({url:tify_ajaxurl,dataType:"json",method:"POST",data:{action:this.element.data("edit_action"),_ajax_nonce:this.element.data("ajax_nonce"),autocomplete_id:this.element.data("autocomplete_form"),meta_id:o},beforeSend:function(){a.addClass("tiFyGoogleMap-marker--loading"),t._closePanel()},success:function(e){e.success&&t._updatePanel(e.data)},complete:function(){a.length&&a.removeClass("tiFyGoogleMap-marker--loading")}}):(e.stopPropagation(),$(".tiFyControl-adminPanel",this.panel).tiFyAdminPanel("open"))},_isMapMarker:function(e){var t=void 0!==e?e:0;return void 0!==this.markers[t]},_setMarkers:function(e){for(var t in e)this._updateMapMarker(t,e[t],!1)},_updateMapMarker:function(e,t,a){var o=new google.maps.LatLng(t.lat,t.lng),n=void 0!==a&&a,i=new google.maps.Marker({position:o,icon:this.markersTypes[t.type].icon.src,map:this.map,animation:google.maps.Animation.DROP,title:t.title,draggable:!0});this._isMapMarker(e)&&this._removeMapMarker(e),this.markers[e]=i,this._addMapMarkerClickEvent(e,this.markers[e]),this._addMapMarkerDragEvent(e,this.markers[e]),n&&this.map.setCenter(o)},_removeMapMarker:function(e){this.markers[e].setMap(null),delete this.markers[e]},_centerMap:function(e){var t=void 0!==e?e:0;this._isMapMarker(t)?this.map.setCenter(this.markers[t].getPosition()):this.map.setCenter(this.mapCenter)},_addMapMarkerClickEvent:function(e,t){var a=this;t.addListener("click",function(){$('[data-id="'+e+'"]',a.markersList).find(".tiFyGoogleMap-markerEdit").trigger("click")})},_addMapMarkerDragEvent:function(e,t){var a=this;t.addListener("dragend",function(){var t=$('[data-id="'+e+'"]',a.markersList);$.ajax({url:tify_ajaxurl,dataType:"json",method:"POST",data:{action:a.element.data("drag_action"),_ajax_nonce:a.element.data("ajax_nonce"),meta_id:e,lat:this.getPosition().lat(),lng:this.getPosition().lng()},beforeSend:function(){t.addClass("tiFyGoogleMap-marker--loading"),a._closePanel()},complete:function(){t.length&&t.removeClass("tiFyGoogleMap-marker--loading")}})})},_toggleBounceMarker:function(e,t){var a=void 0!==t&&t;this._isMapMarker(e)&&(null===this.markers[e].getAnimation()||a?this.markers[e].setAnimation(google.maps.Animation.BOUNCE):this.markers[e].setAnimation(null))},_removeMarkersAnimation:function(e){var t=void 0!==e?e:0;for(var a in this.markers)a!=t&&null!==this.markers[a].getAnimation()&&this.markers[a].setAnimation(null)},_clean:function(){$(".tiFyGoogleMap-marker--editing",this.markersList).removeClass("tiFyGoogleMap-marker--editing"),$(".tiFyControl-adminPanel",this.panel).length&&$(".tiFyControl-adminPanel",this.panel).tiFyAdminPanel("isOpened")&&$(".tiFyControl-adminPanel",this.panel).tiFyAdminPanel("close"),this._removeMarkersAnimation()}}),$(".tiFyGoogleMap").tiFyGoogleMapEditor()}(jQuery,document,window);